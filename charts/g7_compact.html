<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calc I vs II - Compact</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        :root {
            --deep-insight: #008384;
            --scholar-blue: #234A5D;
            --warm-thoughts: #4A81A8;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter Tight', sans-serif;
            background: transparent;
            overflow: hidden;
        }
        .container {
            width: 100%;
            height: 100vh;
            padding: 10px 15px;
        }
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 8px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--scholar-blue);
        }
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 3px;
        }
        .legend-dot.calc1 { background: var(--deep-insight); }
        .legend-dot.calc2 { background: var(--warm-thoughts); }
        #chart { width: 100%; height: calc(100% - 30px); }
    </style>
</head>
<body>
    <div class="container">
        <div class="legend">
            <div class="legend-item">
                <div class="legend-dot calc1"></div>
                <span>Calc I</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot calc2"></div>
                <span>Calc II</span>
            </div>
        </div>
        <div id="chart"></div>
    </div>

    <script>
        const regions = ['Southeast', 'Mid East', 'Far West', 'Great Lakes', 'Southwest', 'Rocky Mtns'];
        const calc1Data = [408, 246, 220, 161, 151, 67];
        const calc2Data = [183, 82, 112, 99, 101, 38];

        const traceCalc1 = {
            type: 'bar',
            name: 'Calc I',
            x: regions,
            y: calc1Data,
            text: calc1Data.map(v => v + 'K'),
            textposition: 'outside',
            textfont: { family: 'Inter Tight', size: 9, color: '#008384' },
            marker: { color: '#008384', opacity: 0.9 },
            hovertemplate: '<b>%{x}</b><br>Calc I: %{y}K<extra></extra>'
        };

        const traceCalc2 = {
            type: 'bar',
            name: 'Calc II',
            x: regions,
            y: calc2Data,
            text: calc2Data.map(v => v + 'K'),
            textposition: 'outside',
            textfont: { family: 'Inter Tight', size: 9, color: '#4A81A8' },
            marker: { color: '#4A81A8', opacity: 0.9 },
            hovertemplate: '<b>%{x}</b><br>Calc II: %{y}K<extra></extra>'
        };

        const layout = {
            barmode: 'group',
            bargap: 0.3,
            bargroupgap: 0.1,
            margin: { l: 40, r: 10, t: 5, b: 60 },
            xaxis: {
                tickfont: { family: 'Inter Tight', size: 9, color: '#234A5D' },
                tickangle: -30
            },
            yaxis: {
                showgrid: true,
                gridcolor: '#F0F2F5',
                zeroline: false,
                tickfont: { family: 'Inter Tight', size: 9, color: '#9CA3AF' },
                range: [0, Math.max(...calc1Data) * 1.25]
            },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            showlegend: false
        };

        const config = { displayModeBar: false, responsive: true };

        const trace1Init = { ...traceCalc1, y: calc1Data.map(() => 0), text: [] };
        const trace2Init = { ...traceCalc2, y: calc2Data.map(() => 0), text: [] };

        Plotly.newPlot('chart', [trace1Init, trace2Init], layout, config).then(() => {
            setTimeout(() => {
                Plotly.animate('chart', {
                    data: [
                        { y: calc1Data, text: calc1Data.map(v => v + 'K') },
                        { y: calc2Data, text: calc2Data.map(v => v + 'K') }
                    ],
                    traces: [0, 1]
                }, {
                    transition: { duration: 600, easing: 'cubic-out' },
                    frame: { duration: 600 }
                });
            }, 150);
        });

        function renderFromFilteredData(filters, filteredData) {
            if (!Array.isArray(filteredData) || filteredData.length === 0) {
                return false;
            }

            const regionMap = {};
            const regionOrder = ['Southeast', 'Mid East', 'Far West', 'Great Lakes', 'Southwest', 'Rocky Mountains', 'Plains', 'New England', 'Outlying'];
            const regionLabels = ['Southeast', 'Mid East', 'Far West', 'Great Lakes', 'Southwest', 'Rocky Mtns', 'Plains', 'New England', 'Outlying'];

            regionOrder.forEach(r => { regionMap[r] = { calc1: 0, calc2: 0 }; });

            const selectedRegion = filters && filters.region && filters.region !== 'All'
                ? String(filters.region)
                : '';

            if (selectedRegion) {
                const calc1Total = filteredData.reduce((sum, d) => sum + (Number(d.calc_i) || 0), 0);
                const calc2Total = filteredData.reduce((sum, d) => sum + (Number(d.calc_ii) || 0), 0);
                const regionLabel = selectedRegion === 'Rocky Mountains' ? 'Rocky Mtns' : selectedRegion;

                const k1 = calc1Total > 2000 ? Math.round(calc1Total / 1000) : Math.round(calc1Total);
                const k2 = calc2Total > 2000 ? Math.round(calc2Total / 1000) : Math.round(calc2Total);

                Plotly.animate('chart', {
                    data: [
                        { x: [regionLabel], y: [k1], text: [k1 + 'K'] },
                        { x: [regionLabel], y: [k2], text: [k2 + 'K'] }
                    ],
                    traces: [0, 1]
                }, {
                    transition: { duration: 400, easing: 'cubic-out' },
                    frame: { duration: 400 }
                });

                Plotly.relayout('chart', {
                    'yaxis.range': [0, Math.max(k1, 1) * 1.25]
                });

                return true;
            }

            filteredData.forEach(d => {
                const breakdown = d && d.region_breakdown ? d.region_breakdown : null;
                if (breakdown && Object.keys(breakdown).length > 0) {
                    Object.keys(breakdown).forEach(region => {
                        if (!regionMap[region]) return;
                        regionMap[region].calc1 += Number((breakdown[region] || {}).calc_i) || 0;
                        regionMap[region].calc2 += Number((breakdown[region] || {}).calc_ii) || 0;
                    });
                    return;
                }

                const fallbackRegion = d && d.state && window.BMGF_STATE_TO_REGION ? window.BMGF_STATE_TO_REGION[d.state] : '';
                if (fallbackRegion && regionMap[fallbackRegion]) {
                    regionMap[fallbackRegion].calc1 += Number(d.calc_i) || 0;
                    regionMap[fallbackRegion].calc2 += Number(d.calc_ii) || 0;
                }
            });

            const newRegions = [];
            const newCalc1 = [];
            const newCalc2 = [];
            regionOrder.forEach((r, i) => {
                const raw1 = regionMap[r].calc1;
                const raw2 = regionMap[r].calc2;
                const c1 = raw1 > 2000 ? Math.round(raw1 / 1000) : Math.round(raw1);
                const c2 = raw2 > 2000 ? Math.round(raw2 / 1000) : Math.round(raw2);
                if (c1 > 0 || c2 > 0) {
                    newRegions.push(regionLabels[i]);
                    newCalc1.push(c1);
                    newCalc2.push(c2);
                }
            });

            Plotly.animate('chart', {
                data: [
                    { x: newRegions, y: newCalc1, text: newCalc1.map(v => v + 'K') },
                    { x: newRegions, y: newCalc2, text: newCalc2.map(v => v + 'K') }
                ],
                traces: [0, 1]
            }, {
                transition: { duration: 400, easing: 'cubic-out' },
                frame: { duration: 400 }
            });

            Plotly.relayout('chart', {
                'yaxis.range': [0, Math.max(...newCalc1, 1) * 1.25]
            });

            return true;
        }

        function renderBaseData() {
            Plotly.animate('chart', {
                data: [
                    { x: regions, y: calc1Data, text: calc1Data.map(v => v + 'K') },
                    { x: regions, y: calc2Data, text: calc2Data.map(v => v + 'K') }
                ],
                traces: [0, 1]
            }, {
                transition: { duration: 400, easing: 'cubic-out' },
                frame: { duration: 400 }
            });

            Plotly.relayout('chart', {
                'yaxis.range': [0, Math.max(...calc1Data, 1) * 1.25]
            });
        }

        // Filter update handler
        window.handleFilterUpdate = function(filters, filteredData) {
            const rendered = renderFromFilteredData(filters || {}, filteredData);
            if (!rendered) {
                renderBaseData();
            }
        };
    </script>
    <script src="filter-receiver.js"></script>
</body>
</html>
