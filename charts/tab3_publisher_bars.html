<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publisher Market Share with Logos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:wght@400;500;600;700&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --deep-insight: #008384;
            --scholar-blue: #234A5D;
            --warm-thoughts: #4A81A8;
            --sky-logic: #4A81A8;
            --coastal-clarity: #7FBFC0;
            --soft-lecture: #92A4CF;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter Tight', sans-serif;
            background: transparent;
            overflow: hidden;
        }
        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding: 20px 20px 15px;
            gap: 18px;
        }
        .publisher-row {
            display: flex;
            align-items: center;
            gap: 12px;
            opacity: 0;
            transform: translateX(-20px);
            animation: slideIn 0.4s ease forwards;
        }
        .publisher-row:nth-child(1) { animation-delay: 0.1s; }
        .publisher-row:nth-child(2) { animation-delay: 0.2s; }
        .publisher-row:nth-child(3) { animation-delay: 0.3s; }
        .publisher-row:nth-child(4) { animation-delay: 0.4s; }
        .publisher-row:nth-child(5) { animation-delay: 0.5s; }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .logo-container {
            width: 80px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .logo-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .logo-placeholder {
            font-size: 10px;
            font-weight: 600;
            color: var(--scholar-blue);
            text-align: center;
            background: #F0F2F5;
            border-radius: 4px;
            padding: 8px 4px;
            width: 100%;
        }
        .bar-container {
            flex: 1;
            height: 36px;
            background: #F0F2F5;
            border-radius: 18px;
            overflow: hidden;
            position: relative;
        }
        .bar-fill {
            height: 100%;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 14px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            width: 0;
        }
        .bar-fill.animate {
        }
        .bar-value {
            font-size: 14px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .bar-value-outside {
            font-size: 14px;
            font-weight: 700;
            color: var(--scholar-blue);
            margin-left: 10px;
            min-width: 40px;
        }

        .cengage .bar-fill { background: linear-gradient(90deg, #008384, #00a5a7); }
        .pearson .bar-fill { background: linear-gradient(90deg, #234A5D, #3a6a82); }
        .openstax .bar-fill { background: linear-gradient(90deg, #7FBFC0, #9dd4d5); }
        .wiley .bar-fill { background: linear-gradient(90deg, #4A81A8, #6a9fc4); }
        .other .bar-fill { background: linear-gradient(90deg, #92A4CF, #b0bee0); }
    </style>
</head>
<body>
    <div class="container" id="container">
    </div>

    <script>
        const container = document.getElementById('container');

        const logoByPublisher = {
            'Cengage': '../assets/publisher_logos/cengage-learning-seeklogo.png',
            'Pearson': '../assets/publisher_logos/pearson-seeklogo.png',
            'OpenStax': '../assets/publisher_logos/open_stax_logo.png',
            'Wiley': '../assets/publisher_logos/cdnlogo.com_wiley.png'
        };
        const fallbackTotals = { Cengage: 47, Pearson: 22, OpenStax: 13, Wiley: 7, Other: 11 };

        function getPublisherClass(name) {
            const key = String(name || '').toLowerCase();
            if (key === 'cengage') return 'cengage';
            if (key === 'pearson') return 'pearson';
            if (key === 'openstax') return 'openstax';
            if (key === 'wiley') return 'wiley';
            return 'other';
        }

        function aggregatePublishers(rows) {
            const totals = {};
            (Array.isArray(rows) ? rows : []).forEach(item => {
                const breakdown = item && item.publisher_breakdown ? item.publisher_breakdown : {};
                const names = Object.keys(breakdown);
                if (names.length > 0) {
                    names.forEach(name => {
                        const entry = breakdown[name] || {};
                        const total = Number(entry.total) || 0;
                        if (name && total > 0) {
                            totals[name] = (totals[name] || 0) + total;
                        }
                    });
                    return;
                }

                // Backward compatibility fallback.
                [['pub1', 'pub1_enr'], ['pub2', 'pub2_enr'], ['pub3', 'pub3_enr']].forEach(([nameKey, enrKey]) => {
                    const name = item ? item[nameKey] : '';
                    const enr = item ? (Number(item[enrKey]) || 0) : 0;
                    if (name && enr > 0) {
                        totals[name] = (totals[name] || 0) + enr;
                    }
                });
            });
            return totals;
        }

        function mapToChartData(totals) {
            const totalEnrollment = Object.values(totals).reduce((sum, value) => sum + value, 0);
            if (totalEnrollment <= 0) return [];

            return Object.entries(totals)
                .map(([name, enrollment]) => ({
                    name,
                    value: Math.round((enrollment / totalEnrollment) * 100),
                    enrollment,
                    class: getPublisherClass(name),
                    logo: logoByPublisher[name] || null
                }))
                .sort((a, b) => b.enrollment - a.enrollment)
                .slice(0, 5);
        }

        function renderRows(publishers) {
            container.innerHTML = '';

            if (!Array.isArray(publishers) || publishers.length === 0) {
                return;
            }

            publishers.forEach((pub, index) => {
                const row = document.createElement('div');
                row.className = `publisher-row ${pub.class}`;

                row.innerHTML = `
                    <div class="logo-container">
                        ${pub.logo
                            ? `<img src="${pub.logo}" alt="${pub.name}" onerror="this.parentElement.innerHTML='<div class=\\'logo-placeholder\\'>${pub.name}</div>'">`
                            : `<div class="logo-placeholder">${pub.name}</div>`
                        }
                    </div>
                    <div class="bar-container">
                        <div class="bar-fill" id="bar-${index}" style="width: 0%">
                            <span class="bar-value">${pub.value}%</span>
                        </div>
                    </div>
                `;

                container.appendChild(row);
            });

            const maxValue = Math.max(...publishers.map(p => p.value));
            const minValue = Math.min(...publishers.map(p => p.value));
            const minWidth = 18;
            const maxWidth = 95;

            setTimeout(() => {
                publishers.forEach((pub, index) => {
                    const bar = document.getElementById(`bar-${index}`);
                    if (!bar) return;
                    const range = Math.max(maxValue - minValue, 1);
                    const width = minWidth + ((pub.value - minValue) / range) * (maxWidth - minWidth);
                    bar.style.width = `${width}%`;
                });
            }, 180);
        }

        function getInitialRows() {
            const stateRows = (window.BMGF_DATA && Array.isArray(window.BMGF_DATA.state_data))
                ? window.BMGF_DATA.state_data
                : [];
            return stateRows;
        }

        const initialData = mapToChartData(aggregatePublishers(getInitialRows()));
        renderRows(initialData.length > 0 ? initialData : mapToChartData(fallbackTotals));

        // Filter update handler
        window.handleFilterUpdate = function(filters, filteredData) {
            const rows = Array.isArray(filteredData) ? filteredData : getInitialRows();
            const computed = mapToChartData(aggregatePublishers(rows));
            renderRows(computed.length > 0 ? computed : mapToChartData(fallbackTotals));
        };
    </script>
    <script src="filter-receiver.js"></script>
</body>
</html>
