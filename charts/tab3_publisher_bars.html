<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publisher Market Share with Logos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:wght@400;500;600;700&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --deep-insight: #008384;
            --scholar-blue: #234A5D;
            --warm-thoughts: #4A81A8;
            --sky-logic: #4A81A8;
            --coastal-clarity: #7FBFC0;
            --soft-lecture: #92A4CF;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter Tight', sans-serif;
            background: transparent;
            overflow: hidden;
        }
        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding: 20px 20px 15px;
            gap: 18px;
        }
        .publisher-row {
            display: flex;
            align-items: center;
            gap: 12px;
            opacity: 0;
            transform: translateX(-20px);
            animation: slideIn 0.4s ease forwards;
        }
        .publisher-row:nth-child(1) { animation-delay: 0.1s; }
        .publisher-row:nth-child(2) { animation-delay: 0.2s; }
        .publisher-row:nth-child(3) { animation-delay: 0.3s; }
        .publisher-row:nth-child(4) { animation-delay: 0.4s; }
        .publisher-row:nth-child(5) { animation-delay: 0.5s; }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .logo-container {
            width: 80px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .logo-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .logo-placeholder {
            font-size: 10px;
            font-weight: 600;
            color: var(--scholar-blue);
            text-align: center;
            background: #F0F2F5;
            border-radius: 4px;
            padding: 8px 4px;
            width: 100%;
        }
        .bar-container {
            flex: 1;
            height: 36px;
            background: #F0F2F5;
            border-radius: 18px;
            overflow: hidden;
            position: relative;
        }
        .bar-fill {
            height: 100%;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 14px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            width: 0;
        }
        .bar-fill.animate {
        }
        .bar-value {
            font-size: 14px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .bar-value-outside {
            font-size: 14px;
            font-weight: 700;
            color: var(--scholar-blue);
            margin-left: 10px;
            min-width: 40px;
        }

        .cengage .bar-fill { background: linear-gradient(90deg, #008384, #00a5a7); }
        .pearson .bar-fill { background: linear-gradient(90deg, #234A5D, #3a6a82); }
        .openstax .bar-fill { background: linear-gradient(90deg, #7FBFC0, #9dd4d5); }
        .wiley .bar-fill { background: linear-gradient(90deg, #4A81A8, #6a9fc4); }
        .other .bar-fill { background: linear-gradient(90deg, #92A4CF, #b0bee0); }
    </style>
</head>
<body>
    <div class="container" id="container">
    </div>

    <script>
        const publishers = [
            { name: 'Cengage', value: 47, institutions: 436, class: 'cengage', logo: '../assets/publisher_logos/cengage-learning-seeklogo.png' },
            { name: 'Pearson', value: 22, institutions: 203, class: 'pearson', logo: '../assets/publisher_logos/pearson-seeklogo.png' },
            { name: 'OpenStax', value: 13, institutions: 118, class: 'openstax', logo: '../assets/publisher_logos/open_stax_logo.png' },
            { name: 'Wiley', value: 7, institutions: 67, class: 'wiley', logo: '../assets/publisher_logos/cdnlogo.com_wiley.png' },
            { name: 'Other', value: 11, institutions: 110, class: 'other', logo: null }
        ];

        const container = document.getElementById('container');

        publishers.forEach((pub, index) => {
            const row = document.createElement('div');
            row.className = `publisher-row ${pub.class}`;

            const showValueOutside = false;

            row.innerHTML = `
                <div class="logo-container">
                    ${pub.logo
                        ? `<img src="${pub.logo}" alt="${pub.name}" onerror="this.parentElement.innerHTML='<div class=\\'logo-placeholder\\'>${pub.name}</div>'">`
                        : `<div class="logo-placeholder">${pub.name}</div>`
                    }
                </div>
                <div class="bar-container">
                    <div class="bar-fill" id="bar-${index}" style="width: 0%">
                        ${!showValueOutside ? `<span class="bar-value">${pub.value}%</span>` : ''}
                    </div>
                </div>
                ${showValueOutside ? `<span class="bar-value-outside">${pub.value}%</span>` : ''}
            `;

            container.appendChild(row);
        });

        const maxValue = Math.max(...publishers.map(p => p.value));
        const minValue = Math.min(...publishers.map(p => p.value));
        const minWidth = 18;
        const maxWidth = 95;

        setTimeout(() => {
            publishers.forEach((pub, index) => {
                const bar = document.getElementById(`bar-${index}`);
                const width = minWidth + ((pub.value - minValue) / (maxValue - minValue)) * (maxWidth - minWidth);
                bar.style.width = `${width}%`;
            });
        }, 300);

        // Filter update handler
        window.handleFilterUpdate = function(filters, filteredData) {
            if (!filteredData || filteredData.length === 0) return;

            // Aggregate publisher enrollment from stateData
            const pubTotals = {};
            filteredData.forEach(d => {
                [['pub1', 'pub1_enr'], ['pub2', 'pub2_enr'], ['pub3', 'pub3_enr']].forEach(([nameKey, enrKey]) => {
                    const name = d[nameKey];
                    const enr = d[enrKey] || 0;
                    if (name && enr > 0) {
                        pubTotals[name] = (pubTotals[name] || 0) + enr;
                    }
                });
            });

            const totalEnr = Object.values(pubTotals).reduce((s, v) => s + v, 0);
            if (totalEnr === 0) return;

            const pubClassMap = { 'Cengage': 'cengage', 'Pearson': 'pearson', 'OpenStax': 'openstax', 'Wiley': 'wiley' };
            const newPubs = Object.entries(pubTotals)
                .map(([name, enr]) => ({
                    name: name,
                    value: Math.round(enr / totalEnr * 100),
                    class: pubClassMap[name] || 'other'
                }))
                .sort((a, b) => b.value - a.value)
                .slice(0, 5);

            const newMax = Math.max(...newPubs.map(p => p.value));
            const newMin = Math.min(...newPubs.map(p => p.value));

            newPubs.forEach((pub, index) => {
                const bar = document.getElementById(`bar-${index}`);
                const row = bar ? bar.closest('.publisher-row') : null;
                if (bar && row) {
                    const barValue = bar.querySelector('.bar-value');
                    if (barValue) barValue.textContent = pub.value + '%';
                    const width = 18 + ((pub.value - newMin) / (Math.max(newMax - newMin, 1))) * 77;
                    bar.style.width = width + '%';
                }
            });
        };
    </script>
    <script src="filter-receiver.js"></script>
</body>
</html>
