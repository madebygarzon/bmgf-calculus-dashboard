<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top States - Compact</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        :root {
            --deep-insight: #008384;
            --scholar-blue: #234A5D;
            --warm-thoughts: #4A81A8;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter Tight', sans-serif;
            background: transparent;
            overflow: hidden;
        }
        .container {
            width: 100%;
            height: 100vh;
            padding: 10px 15px;
        }
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 8px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--scholar-blue);
        }
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .legend-dot.calc1 { background: var(--deep-insight); }
        .legend-dot.calc2 { background: var(--warm-thoughts); }
        #chart { width: 100%; height: calc(100% - 30px); }
    </style>
</head>
<body>
    <div class="container">
        <div class="legend">
            <div class="legend-item">
                <div class="legend-dot calc1"></div>
                <span>Calc I</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot calc2"></div>
                <span>Calc II</span>
            </div>
        </div>
        <div id="chart"></div>
    </div>

    <script>
        const stateData = [
            { state: "California", calc1: 155, calc2: 78 },
            { state: "Texas", calc1: 140, calc2: 95 },
            { state: "Florida", calc1: 128, calc2: 52 },
            { state: "New York", calc1: 85, calc2: 35 },
            { state: "Ohio", calc1: 58, calc2: 36 },
            { state: "N. Carolina", calc1: 52, calc2: 28 },
            { state: "Pennsylvania", calc1: 48, calc2: 25 },
            { state: "Illinois", calc1: 46, calc2: 28 }
        ];

        stateData.sort((a, b) => a.calc1 - b.calc1);

        const states = stateData.map(d => d.state);
        const calc1 = stateData.map(d => d.calc1);
        const calc2 = stateData.map(d => d.calc2);

        const traces = [
            {
                type: 'scatter',
                mode: 'lines',
                x: stateData.flatMap(d => [d.calc2, d.calc1, null]),
                y: stateData.flatMap(d => [d.state, d.state, null]),
                line: { color: '#E5E7EB', width: 5 },
                showlegend: false,
                hoverinfo: 'skip'
            },
            {
                type: 'scatter',
                mode: 'markers+text',
                x: calc2,
                y: states,
                text: calc2.map(v => v + 'K'),
                textposition: 'bottom center',
                textfont: { family: 'Inter Tight', size: 8, color: '#4A81A8' },
                marker: { size: 12, color: '#4A81A8', line: { color: '#FFF', width: 2 } },
                hovertemplate: '<b>%{y}</b><br>Calc II: %{x}K<extra></extra>',
                showlegend: false
            },
            {
                type: 'scatter',
                mode: 'markers+text',
                x: calc1,
                y: states,
                text: calc1.map(v => v + 'K'),
                textposition: 'top center',
                textfont: { family: 'Inter Tight', size: 8, color: '#008384' },
                marker: { size: 12, color: '#008384', line: { color: '#FFF', width: 2 } },
                hovertemplate: '<b>%{y}</b><br>Calc I: %{x}K<extra></extra>',
                showlegend: false
            }
        ];

        const layout = {
            margin: { l: 75, r: 20, t: 5, b: 30 },
            xaxis: {
                showgrid: true,
                gridcolor: '#F0F2F5',
                zeroline: false,
                tickfont: { family: 'Inter Tight', size: 9, color: '#9CA3AF' },
                range: [0, Math.max(...calc1) * 1.15]
            },
            yaxis: {
                showgrid: false,
                tickfont: { family: 'Inter Tight', size: 10, color: '#234A5D' }
            },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            hovermode: 'closest'
        };

        const config = { displayModeBar: false, responsive: true };

        const initTraces = [
            { ...traces[0], x: stateData.flatMap(() => [0, 0, null]) },
            { ...traces[1], x: calc2.map(() => 0), text: [], marker: { ...traces[1].marker, size: 0 } },
            { ...traces[2], x: calc1.map(() => 0), text: [], marker: { ...traces[2].marker, size: 0 } }
        ];

        Plotly.newPlot('chart', initTraces, layout, config).then(() => {
            setTimeout(() => {
                Plotly.animate('chart', {
                    data: [
                        { x: stateData.flatMap(d => [d.calc2, d.calc1, null]) },
                        { x: calc2, text: calc2.map(v => v + 'K'), marker: { size: 12 } },
                        { x: calc1, text: calc1.map(v => v + 'K'), marker: { size: 12 } }
                    ],
                    traces: [0, 1, 2]
                }, {
                    transition: { duration: 400, easing: 'cubic-out' },
                    frame: { duration: 400 }
                });
            }, 100);
        });

        function hasActiveFilters(filters) {
            if (!filters || typeof filters !== 'object') return false;
            return Object.keys(filters).some(key => String(filters[key] || 'All') !== 'All');
        }

        function renderEmptyState() {
            Plotly.animate('chart', {
                data: [
                    { x: [], y: [] },
                    { x: [], y: [], text: [] },
                    { x: [], y: [], text: [] }
                ],
                traces: [0, 1, 2]
            }, {
                transition: { duration: 300, easing: 'cubic-out' },
                frame: { duration: 300 }
            });

            Plotly.relayout('chart', {
                'xaxis.range': [0, 1]
            });
        }

        // Filter update handler
        window.handleFilterUpdate = function(filters, filteredData) {
            if (!filteredData || filteredData.length === 0) {
                if (hasActiveFilters(filters)) {
                    renderEmptyState();
                }
                return;
            }

            const topStates = [...filteredData]
                .sort((a, b) => b.total - a.total)
                .slice(0, 8)
                .map(d => ({
                    state: d.state.length > 10 ? d.state.substring(0, 10) + '.' : d.state,
                    calc1: Math.round((d.calc_i || 0) / 1000),
                    calc2: Math.round((d.calc_ii || 0) / 1000)
                }));

            topStates.sort((a, b) => a.calc1 - b.calc1);

            const newStates = topStates.map(d => d.state);
            const newCalc1 = topStates.map(d => d.calc1);
            const newCalc2 = topStates.map(d => d.calc2);

            Plotly.animate('chart', {
                data: [
                    { x: topStates.flatMap(d => [d.calc2, d.calc1, null]), y: topStates.flatMap(d => [d.state, d.state, null]) },
                    { x: newCalc2, y: newStates, text: newCalc2.map(v => v + 'K'), marker: { size: 12, color: '#4A81A8', line: { color: '#FFF', width: 2 } } },
                    { x: newCalc1, y: newStates, text: newCalc1.map(v => v + 'K'), marker: { size: 12, color: '#008384', line: { color: '#FFF', width: 2 } } }
                ],
                traces: [0, 1, 2]
            }, {
                transition: { duration: 400, easing: 'cubic-out' },
                frame: { duration: 400 }
            });

            Plotly.relayout('chart', {
                'xaxis.range': [0, Math.max(...newCalc1, 1) * 1.15]
            });
        };
    </script>
    <script src="filter-receiver.js"></script>
</body>
</html>
