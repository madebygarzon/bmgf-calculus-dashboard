<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publisher Market Share - Radial</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:wght@400;500;600;700&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --deep-insight: #008384;
            --scholar-blue: #234A5D;
            --warm-thoughts: #4A81A8;
            --sky-logic: #4A81A8;
            --coastal-clarity: #7FBFC0;
            --soft-lecture: #92A4CF;
            --text-muted: #6B7280;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter Tight', sans-serif;
            background: transparent;
            overflow: hidden;
        }
        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 10px 10px 10px;
        }
        .radial-wrapper {
            position: relative;
            width: 240px;
            height: 240px;
            flex-shrink: 0;
        }
        .radial-svg {
            width: 100%;
            height: 100%;
            overflow: visible;
        }
        .center-text {
            font-family: 'Inter Tight', sans-serif;
            fill: var(--scholar-blue);
        }
        .center-number { font-size: 24px; font-weight: 700; }
        .center-label {
            font-family: 'Inter Tight', sans-serif;
            font-size: 10px;
            fill: var(--text-muted);
        }
        .radial-track {
            fill: none;
            stroke: #E8EAED;
            stroke-linecap: round;
        }
        .radial-bar {
            fill: none;
            stroke-linecap: round;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
            cursor: pointer;
            transition: stroke-width 0.2s ease;
        }
        .radial-bar:hover {
            stroke-width: 14px !important;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }
        .legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 4px 12px;
            margin-top: 20px;
            max-width: 100%;
            padding: 0 5px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 9px;
            color: var(--scholar-blue);
            white-space: nowrap;
        }
        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .legend-value {
            font-weight: 700;
            color: var(--deep-insight);
        }
        .tooltip {
            position: fixed;
            background: #234A5D;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s ease;
            z-index: 100;
        }
        .tooltip.visible { opacity: 1; }
    </style>
</head>
<body>
    <div class="container">
        <div class="radial-wrapper">
            <svg id="radial-chart" class="radial-svg" viewBox="-30 -30 230 230"></svg>
        </div>
        <div id="legend" class="legend"></div>
    </div>
    <div id="tooltip" class="tooltip"></div>

    <script>
        // Default configuration
        const defaultConfig = {
            labels: ['Cengage', 'Pearson', 'Other', 'Wiley', 'OpenStax', 'Macmillan'],
            values: [39, 23, 18, 9, 5, 3],
            realValues: ['697K', '410K', '331K', '158K', '84K', '62K'],
            colors: ['#008384', '#234A5D', '#92A4CF', '#4A81A8', '#7FBFC0', '#D3DEF6'],
            total: '1.8M',
            totalLabel: 'Enrollment'
        };

        // Build config from dynamic data if available
        function buildConfig() {
            if (window.BMGF_DATA && window.BMGF_DATA.publishers && window.BMGF_DATA.publishers.length > 0) {
                const publishers = window.BMGF_DATA.publishers;
                const totalEnrollment = publishers.reduce((sum, p) => sum + (p.enrollment || 0), 0);

                return {
                    labels: publishers.map(p => p.name),
                    values: publishers.map(p => p.market_share),
                    realValues: publishers.map(p => {
                        const val = p.enrollment || 0;
                        if (val >= 1000000) return (val / 1000000).toFixed(1) + 'M';
                        if (val >= 1000) return Math.round(val / 1000) + 'K';
                        return val.toString();
                    }),
                    colors: publishers.map(p => p.color || '#92A4CF'),
                    total: totalEnrollment >= 1000000
                        ? (totalEnrollment / 1000000).toFixed(1) + 'M'
                        : Math.round(totalEnrollment / 1000) + 'K',
                    totalLabel: 'Enrollment'
                };
            }
            return defaultConfig;
        }

        const config = buildConfig();

        const svg = document.getElementById('radial-chart');
        const legend = document.getElementById('legend');
        const tooltip = document.getElementById('tooltip');
        const cx = 85, cy = 85;
        const startRadius = 38;
        const barWidth = 11;
        const gap = 4;

        const sortedData = config.values
            .map((v, i) => ({ value: v, index: i }))
            .sort((a, b) => b.value - a.value);

        svg.innerHTML = `
            <text x="${cx}" y="${cy}" text-anchor="middle" class="center-text center-number">${config.total}</text>
            <text x="${cx}" y="${cy + 14}" text-anchor="middle" class="center-label">${config.totalLabel}</text>
        `;

        const bars = [];

        sortedData.forEach((item, sortIndex) => {
            const radius = startRadius + sortIndex * (barWidth + gap);
            const percent = item.value / 100;
            const startAngle = 135;
            const maxSweep = 270;
            const endAngle = startAngle + (maxSweep * percent);

            const track = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            track.setAttribute('d', describeArc(cx, cy, radius, startAngle, startAngle + maxSweep));
            track.setAttribute('class', 'radial-track');
            track.setAttribute('stroke-width', barWidth);
            svg.appendChild(track);

            const bar = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            bar.setAttribute('d', describeArc(cx, cy, radius, startAngle, startAngle));
            bar.setAttribute('class', 'radial-bar');
            bar.setAttribute('stroke', config.colors[item.index]);
            bar.setAttribute('stroke-width', barWidth);
            svg.appendChild(bar);

            bars.push({ bar, item, radius, startAngle, endAngle });

            setTimeout(() => {
                animateArc(bar, cx, cy, radius, startAngle, endAngle, 600);
            }, sortIndex * 100);
        });

        setTimeout(() => {
            bars.forEach(({ bar, item }) => {
                bar.addEventListener('mouseenter', () => {
                    tooltip.textContent = `${config.labels[item.index]}: ${config.realValues[item.index]} (${config.values[item.index]}%)`;
                    tooltip.classList.add('visible');
                });
                bar.addEventListener('mousemove', (e) => {
                    tooltip.style.left = (e.clientX + 10) + 'px';
                    tooltip.style.top = (e.clientY - 30) + 'px';
                });
                bar.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('visible');
                });
            });
        }, 700);

        sortedData.forEach((item, i) => {
            const li = document.createElement('div');
            li.className = 'legend-item';
            li.innerHTML = `
                <span class="legend-dot" style="background: ${config.colors[item.index]}"></span>
                <span>${config.labels[item.index]}</span>
                <span class="legend-value">${config.values[item.index]}%</span>
            `;
            li.style.opacity = '0';
            legend.appendChild(li);
            setTimeout(() => {
                li.style.transition = 'opacity 0.3s ease';
                li.style.opacity = '1';
            }, 400 + i * 60);
        });

        function describeArc(cx, cy, r, start, end) {
            const s = polarToCartesian(cx, cy, r, start);
            const e = polarToCartesian(cx, cy, r, end);
            const largeArc = (end - start) > 180 ? 1 : 0;
            return `M ${s.x} ${s.y} A ${r} ${r} 0 ${largeArc} 1 ${e.x} ${e.y}`;
        }

        function polarToCartesian(cx, cy, r, deg) {
            const rad = (deg - 90) * Math.PI / 180;
            return { x: cx + r * Math.cos(rad), y: cy + r * Math.sin(rad) };
        }

        function animateArc(el, cx, cy, r, start, end, dur) {
            const t0 = performance.now();
            function update(t) {
                const p = Math.min((t - t0) / dur, 1);
                const ease = 1 - Math.pow(1 - p, 3);
                el.setAttribute('d', describeArc(cx, cy, r, start, start + (end - start) * ease));
                if (p < 1) requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
        }
    </script>
</body>
</html>
